{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics - ShopStack{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="h3 text-gray-800">Analytics</h1>
            <p class="mb-0 text-muted">Detailed analytics and performance metrics for your store.</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'dashboard:dashboard' %}" class="btn btn-outline-primary">Back to Dashboard</a>
        </div>
    </div>
</div>

<!-- Sales Trend Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Sales Trend (Last 7 Days)</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="salesTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Comparison -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Monthly Comparison</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 text-center">
                        <h5 class="text-primary">This Month</h5>
                        <p class="h4">${{ current_month_stats.revenue|floatformat:2|default:"0.00" }}</p>
                        <p class="text-muted">{{ current_month_stats.orders|default:"0" }} orders</p>
                    </div>
                    <div class="col-6 text-center">
                        <h5 class="text-secondary">Last Month</h5>
                        <p class="h4">${{ last_month_stats.revenue|floatformat:2|default:"0.00" }}</p>
                        <p class="text-muted">{{ last_month_stats.orders|default:"0" }} orders</p>
                    </div>
                </div>
                
                {% if current_month_stats.revenue and last_month_stats.revenue %}
                    {% widthratio current_month_stats.revenue last_month_stats.revenue 100 as growth_percent %}
                    <div class="text-center mt-3">
                        {% if growth_percent > 100 %}
                            <span class="badge badge-success">{{ growth_percent|add:"-100" }}% Growth</span>
                        {% else %}
                            <span class="badge badge-warning">{{ 100|add:growth_percent|add:"-100" }}% Decline</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Category Performance -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Category Performance</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Details Table -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Category Details</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Products</th>
                                <th>Total Sold</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in category_stats %}
                            <tr>
                                <td>{{ category.name }}</td>
                                <td>{{ category.product_count }}</td>
                                <td>{{ category.total_sold }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             style="width: {% widthratio category.total_sold 100 100 %}%" 
                                             aria-valuenow="{{ category.total_sold }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No category data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sales Trend Chart
const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
const salesTrendChart = new Chart(salesCtx, {
    type: 'line',
    data: {
        labels: [
            {% for day in days_data %}'{{ day.date }}'{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        datasets: [{
            label: 'Revenue',
            data: [
                {% for day in days_data %}{{ day.revenue }}{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
        }, {
            label: 'Orders',
            data: [
                {% for day in days_data %}{{ day.orders }}{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            yAxisID: 'y1'
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Revenue ($)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Orders'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});

// Category Performance Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: [
            {% for category in category_stats %}'{{ category.name }}'{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        datasets: [{
            label: 'Products Sold',
            data: [
                {% for category in category_stats %}{{ category.total_sold }}{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
            borderColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
            borderWidth: 1
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Products Sold'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}